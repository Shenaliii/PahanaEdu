<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Records</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f4f4f9; color:#333; margin:0; }
.top-bar { background:#b5001a; color:#fff; padding:8px 20px; display:flex; justify-content:flex-end; gap:10px; }
.top-bar a { color:#fff; text-decoration:none; font-weight:bold; }
.header-bar { background:#fff; border-bottom:1px solid #ddd; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
.header-bar .logo img { height:50px; }
.header-bar .cart-icon i { font-size:24px; color:#b5001a; }
.hero-section { text-align:center; padding:30px 20px; background:#fff0f0; border-bottom:1px solid #ddd; }
.hero-section h1 { margin:0; color:#b5001a; }
.customer-section { max-width:1000px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.customer-controls { display:flex; justify-content:space-between; margin-bottom:15px; gap:10px; flex-wrap:wrap; }
.customer-controls input, .customer-controls select { padding:8px 10px; border-radius:5px; border:1px solid #ccc; width:200px; }
.reset-btn { padding:8px 12px; border:none; border-radius:5px; background:#b5001a; color:#fff; cursor:pointer; }
.customer-table { width:100%; border-collapse:collapse; margin-top:10px; }
.customer-table th, .customer-table td { border:1px solid #eee; padding:10px; text-align:center; }
.customer-table th { background:#f5f5f5; color:#b5001a; }
.customer-table td input { width:100%; padding:5px; border:none; background:transparent; }
.action-btn { display:flex; gap:8px; border:none; background:transparent; cursor:pointer; align-items:center; justify-content:center; padding:4px 6px; border-radius:5px; transition:background 0.2s; }
.action-btn:hover { background:#f0f0f0; }
.edit-icon { color:#b5001a; }
.save-icon { color:#087443; display:none; }
.delete-icon { color:#d11a2a; }
.footer { text-align:center; padding:15px 0; margin-top:20px; background:#f5f5f5; font-size:14px; }
@media(max-width:800px) { .customer-controls { flex-direction:column; gap:8px; } }
</style>
</head>
<body>

<div class="top-bar">
    <a href="help.html">HELP</a>
    <span>|</span>
    <a href="login.html" class="exit-btn">LOG OUT</a>
</div>

<div class="header-bar">
    <div class="logo">
        <img src="../images/logo.jpeg" alt="Logo">
    </div>
    <a href="../html/cart.html">
        <div class="cart-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
    </a>
</div>

<section class="hero-section">
    <h1>Customer Records</h1>
</section>

<section class="customer-section">
    <div class="customer-controls">
        <input type="text" placeholder="Search by ID or Name" id="searchInput">
        <select id="filterSelect">
            <option value="">Sort By</option>
            <option value="name">Name A-Z</option>
            <option value="units">Units Desc</option>
        </select>
        <button class="reset-btn" id="resetBtn">Reset</button>
    </div>

    <table class="customer-table">
        <thead>
            <tr>
                <th>Cus. Acc. No</th>
                <th>Full Name</th>
                <th>Address</th>
                <th>Email</th>
                <th>Phone No</th>
                <th>Units Consumed</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="customerTableBody"></tbody>
    </table>
</section>

<footer class="footer">
    <p>Â© 2025 Pahana Education. All rights reserved.</p>
</footer>

<script>
const API_BASE = "http://localhost:8080/pahanaedu-service/customers";
const tableBody = document.getElementById("customerTableBody");
const searchInput = document.getElementById("searchInput");
const filterSelect = document.getElementById("filterSelect");
const resetBtn = document.getElementById("resetBtn");

let customersData = [];

// Load customers
async function loadCustomers() {
    try {
        const resp = await fetch(API_BASE);
        if(!resp.ok) throw new Error("Failed to fetch customers");
        customersData = await resp.json();
        renderTable(customersData);
    } catch(e) {
        console.error(e);
        alert("Could not load customer records.");
    }
}

// Render table rows
function renderTable(data) {
    tableBody.innerHTML = "";
    data.forEach(c => {
        const tr = document.createElement("tr");
        tr.dataset.id = c.id;
        tr.innerHTML = `
            <td><input type="text" value="${c.id}" disabled></td>
            <td><input type="text" value="${c.name}" disabled></td>
            <td><input type="text" value="${c.address}" disabled></td>
            <td><input type="text" value="${c.email}" disabled></td>
            <td><input type="text" value="${c.mobile}" disabled></td>
            <td><input type="text" value="${c.unit_consumed}" disabled></td>
            <td>
                <button class="action-btn">
                    <i class="fas fa-pen edit-icon" title="Edit"></i>
                    <i class="fas fa-check-circle save-icon" title="Save"></i>
                    <i class="fas fa-trash delete-icon" title="Delete"></i>
                </button>
            </td>
        `;
        attachRowHandlers(tr);
        tableBody.appendChild(tr);
    });
}

// Edit / Save / Delete
function attachRowHandlers(tr) {
    const editIcon = tr.querySelector(".edit-icon");
    const saveIcon = tr.querySelector(".save-icon");
    const deleteIcon = tr.querySelector(".delete-icon");
    const inputs = tr.querySelectorAll("td input");

    // Edit
    editIcon.addEventListener("click", () => {
        inputs.forEach((inp, idx) => { if(idx!==0) inp.disabled=false; inp.style.background="#fff"; });
        inputs[1].focus();
        editIcon.style.display="none";
        saveIcon.style.display="inline";
    });

    // Save
    saveIcon.addEventListener("click", async () => {
        const id = tr.dataset.id;
        const payload = {
            name: inputs[1].value.trim(),
            address: inputs[2].value.trim(),
            email: inputs[3].value.trim(),
            mobile: inputs[4].value.trim(),
            unit_consumed: parseInt(inputs[5].value || "0", 10)
        };
        try {
            const resp = await fetch(`${API_BASE}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if(!resp.ok) throw new Error("Update failed");
            const updatedCustomer = await resp.json();
            const index = customersData.findIndex(c => c.id==id);
            if(index>-1) customersData[index]=updatedCustomer;

            inputs.forEach((inp, idx)=>{ if(idx!==0) inp.disabled=true; inp.style.background="transparent"; });
            editIcon.style.display="inline";
            saveIcon.style.display="none";
            alert("Customer updated successfully!");
        } catch(e) {
            console.error(e);
            alert("Failed to update customer.");
        }
    });

    // Delete
    deleteIcon.addEventListener("click", async () => {
        if(!confirm("Are you sure you want to delete this customer?")) return;
        const id = tr.dataset.id;
        try {
            const resp = await fetch(`${API_BASE}/${id}`, { method:"DELETE" });
            if(!resp.ok) throw new Error("Delete failed");
            tr.remove();
            customersData = customersData.filter(c => c.id!=id);
            alert("Customer deleted successfully!");
        } catch(e) {
            console.error(e);
            alert("Failed to delete customer.");
        }
    });
}

// Search / filter / reset
searchInput.addEventListener("input", () => {
    const term = searchInput.value.toLowerCase();
    renderTable(customersData.filter(c =>
        c.id.toString().includes(term) || c.name.toLowerCase().includes(term)
    ));
});

filterSelect.addEventListener("change", () => {
    let sorted = [...customersData];
    if(filterSelect.value==="name") sorted.sort((a,b)=>a.name.localeCompare(b.name));
    if(filterSelect.value==="units") sorted.sort((a,b)=>b.unit_consumed-a.unit_consumed);
    renderTable(sorted);
});

resetBtn.addEventListener("click", () => {
    searchInput.value="";
    filterSelect.value="";
    renderTable(customersData);
});

// Initial load
loadCustomers();
</script>

</body>
</html>
