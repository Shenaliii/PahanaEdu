<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Invoice - Pahana Education</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; }
  .container { max-width: 1100px; margin-top: 30px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  h1 { text-align: center; margin-bottom: 30px; color: #343a40; }
  label { font-weight: 600; }
  .form-control[readonly] { background-color: #e9ecef; }
  table th, table td { vertical-align: middle !important; }
  .btn-ghost-danger { background: transparent; border: none; color: #dc3545; }
</style>
</head>
<body>

<div class="container">
  <h1>Create Invoice</h1>

  <!-- Customer Info -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label>Search Customer (Mobile)</label>
      <input type="text" id="customerSearch" class="form-control" placeholder="Enter mobile to search">
    </div>
    <div class="col-md-4">
      <label>Name</label>
      <input type="text" id="BName" class="form-control" readonly>
    </div>
    <div class="col-md-4">
      <label>Mobile</label>
      <input type="text" id="BNumber" class="form-control" readonly>
    </div>
    <div class="col-md-12 mt-2">
      <label>Address</label>
      <textarea id="BAddress" rows="2" class="form-control" readonly></textarea>
    </div>
  </div>

  <!-- Item Search -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label>Item ID</label>
      <input type="number" id="itemSearch" class="form-control" placeholder="Enter Item ID">
    </div>
    <div class="col-md-2">
      <label>Qty</label>
      <input type="number" id="itemQty" class="form-control" min="1" value="1">
    </div>
    <div class="col-md-2">
      <label>&nbsp;</label>
      <button id="addItemBtn" class="btn btn-primary w-100 mt-2" disabled>Add Item</button>
    </div>
    <div class="col-md-5">
      <div><strong>Name:</strong> <span id="itemName"></span></div>
      <div><strong>Price:</strong> Rs. <span id="itemPrice"></span></div>
      <div><strong>Stock:</strong> <span id="itemStock"></span></div>
    </div>
  </div>

  <!-- Invoice Table -->
  <div class="table-responsive">
    <table class="table table-bordered text-center" id="invoiceTable">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="invoiceItems"></tbody>
    </table>
  </div>

  <!-- Totals -->
  <div class="row justify-content-end mt-3">
    <div class="col-md-4">
      <div class="mb-2">
        <label>Subtotal</label>
        <input type="text" id="productSubtotal" class="form-control" readonly>
      </div>
      <div>
        <label>Total</label>
        <input type="text" id="productTotalAmount" class="form-control" readonly>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="mb-3 mt-3">
    <label>Note</label>
    <textarea id="InvoiceNote" class="form-control" rows="2" placeholder="Thanks for your business"></textarea>
  </div>

  <!-- Buttons -->
  <div class="text-center">
    <button id="btnSave" class="btn btn-success me-2" disabled><i class="fa fa-save"></i> Save</button>
    <button id="btnPrint" class="btn btn-primary" disabled><i class="fa fa-print"></i> Preview & Print</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Globals
let token = localStorage.getItem("token") || "";
let customers = [];
let items = [];
let billItems = [];
let selectedCustomer = null;
let selectedItem = null;

// Fetch data
async function fetchData() {
  try {
    const cRes = await fetch("http://localhost:8080/pahanaedu-service/customers", { headers: { Authorization: "Bearer " + token } });
    customers = await cRes.json();
    const iRes = await fetch("http://localhost:8080/pahanaedu-service/items", { headers: { Authorization: "Bearer " + token } });
    items = await iRes.json();
  } catch (err) { console.error(err); }
}

// Search Customer
function searchCustomer() {
  const val = document.getElementById("customerSearch").value.trim();
  selectedCustomer = customers.find(c => c.mobile.includes(val)) || null;
  document.getElementById("BName").value = selectedCustomer?.name || "";
  document.getElementById("BNumber").value = selectedCustomer?.mobile || "";
  document.getElementById("BAddress").value = selectedCustomer?.address || "";
  updateButtonsState();
}

// Search Item
function searchItem() {
  const id = parseInt(document.getElementById("itemSearch").value);
  selectedItem = items.find(i => i.id === id) || null;
  document.getElementById("itemName").innerText = selectedItem?.name || "";
  document.getElementById("itemPrice").innerText = selectedItem?.price?.toFixed(2) || "";
  document.getElementById("itemStock").innerText = selectedItem?.quantity || "";
  updateButtonsState();
}

// Add item
function addItem() {
  if (!selectedItem || !selectedCustomer) return;
  const qty = parseInt(document.getElementById("itemQty").value);
  if (qty > selectedItem.quantity) { Swal.fire('Error','Insufficient stock','error'); return; }
  const idx = billItems.findIndex(b => b.item.id === selectedItem.id);
  if (idx !== -1) {
    billItems[idx].quantity += qty;
    billItems[idx].subtotal = billItems[idx].quantity * selectedItem.price;
  } else {
    billItems.push({item: selectedItem, quantity: qty, subtotal: qty * selectedItem.price});
  }
  renderInvoice();
  clearItemInputs();
}

// Clear item input
function clearItemInputs() {
  document.getElementById("itemSearch").value = "";
  document.getElementById("itemQty").value = 1;
  document.getElementById("itemName").innerText = "";
  document.getElementById("itemPrice").innerText = "";
  document.getElementById("itemStock").innerText = "";
  selectedItem = null;
  updateButtonsState();
}

// Render invoice
function renderInvoice() {
  const tbody = document.getElementById("invoiceItems");
  tbody.innerHTML = "";
  billItems.forEach((b, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="item-name">${b.item.name}</td>
      <td class="item-qty">${b.quantity}</td>
      <td class="item-price">${b.item.price.toFixed(2)}</td>
      <td class="item-subtotal">${b.subtotal.toFixed(2)}</td>
      <td><button class="btn-ghost-danger btn btn-sm" data-index="${i}"><i class="fa fa-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".btn-ghost-danger").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const idx = parseInt(e.currentTarget.dataset.index);
      billItems.splice(idx,1); renderInvoice(); updateButtonsState();
    });
  });

  updateTotals();
}

// Update totals
function updateTotals() {
  const subtotal = billItems.reduce((s,b)=>s+b.subtotal,0);
  document.getElementById("productSubtotal").value = subtotal.toFixed(2);
  document.getElementById("productTotalAmount").value = subtotal.toFixed(2);
}

// Update buttons
function updateButtonsState() {
  document.getElementById("addItemBtn").disabled = !selectedCustomer || !selectedItem;
  const hasItems = billItems.length>0;
  const hasCustomer = !!selectedCustomer;
  document.getElementById("btnSave").disabled = !hasItems || !hasCustomer;
  document.getElementById("btnPrint").disabled = !hasItems || !hasCustomer;
}

// Save invoice
async function saveInvoice(saveOnly=false) {
  if(!selectedCustomer || billItems.length===0){ Swal.fire('Warning','Add customer and items','warning'); return; }
  const payload = {
    customer: {id:selectedCustomer.id},
    note: document.getElementById("InvoiceNote").value,
    billItems: billItems.map(b=>({item:{id:b.item.id},quantity:b.quantity,subtotal:b.subtotal,price:b.item.price})),
    totalAmount: parseFloat(document.getElementById("productTotalAmount").value)
  };
  try{
    const res = await fetch("http://localhost:8080/pahanaedu-service/bills",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
      body:JSON.stringify(payload)
    });
    if(res.ok){
      Swal.fire('Success','Invoice saved','success');
      // save locally for print preview
      localStorage.setItem("invoiceData", JSON.stringify({
        customer: selectedCustomer,
        billItems: billItems.map(b=>({item:{name:b.item.name, price:b.item.price},quantity:b.quantity, subtotal:b.subtotal})),
        totalAmount: parseFloat(document.getElementById("productTotalAmount").value),
        note: document.getElementById("InvoiceNote").value
      }));
      if(!saveOnly) window.location.href = "view_invoice.html";
      billItems=[]; renderInvoice(); clearInvoiceForm();
    } else Swal.fire('Error','Failed to save','error');
  }catch(e){ console.error(e); Swal.fire('Error','Something went wrong','error'); }
}

// Clear form
function clearInvoiceForm(){
  document.getElementById("BName").value="";
  document.getElementById("BNumber").value="";
  document.getElementById("BAddress").value="";
  document.getElementById("InvoiceNote").value="";
  selectedCustomer=null;
  updateButtonsState();
}

// Events
document.getElementById("customerSearch").addEventListener("input", searchCustomer);
document.getElementById("itemSearch").addEventListener("input",()=>setTimeout(searchItem,300));
document.getElementById("addItemBtn").addEventListener("click", addItem);
document.getElementById("btnSave").addEventListener("click", ()=>saveInvoice(true));
document.getElementById("btnPrint").addEventListener("click", ()=>saveInvoice(false));

// Init
fetchData();
</script>
</body>
</html>
